@model Hackathon_2025_ESG.Areas.Client.Models.EsgAnalysisViewModel

@{
    ViewData["Title"] = "AI ESG Analytics";
    Layout = "_Layout";
}

<link rel="stylesheet" href="~/css/uploadDocsPage.css" />

<div class="container">
    <div class="header-section">
        <div class="icon">⚡️</div>
        <h1>AI ESG Analytics</h1>
        <p>Advanced artificial intelligence for comprehensive ESG assessment. Upload your documents and receive intelligent analysis across Environmental, Social, and Governance dimensions.</p>
    </div>

    <form asp-area="Client" asp-controller="UploadDocs" asp-action="GenerateAnalysis" method="post" enctype="multipart/form-data" id="esg-form">
        <div class="esg-grid">
            <div class="esg-card">
                <svg class="card-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" color="#2ecc71"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z" opacity=".3"></path><path d="M17.73 4.27c-1.54-1.54-3.59-2.52-5.73-2.52s-4.19.98-5.73 2.52C4.98 5.81 4 7.86 4 10c0 2.14.98 4.19 2.52 5.73C7.81 17.02 9.86 18 12 18s4.19-.98 5.73-2.52C19.02 14.19 20 12.14 20 10c0-2.14-.98-4.19-2.27-5.73zM12 20c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-3.29-8.71L10 12.59l4.29-4.3 1.41 1.41L10 15.41 7.29 12.7l1.42-1.41z"></path></svg>
                <h3>Environmental</h3>
                <p>Carbon footprint, energy efficiency, sustainability metrics</p>
                <label for="environmental-files" class="drop-zone" id="environmental-drop-zone">
                    <div class="drop-zone-prompt">
                        <svg class="drop-zone-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"></path></svg>
                        <span class="drop-zone-text">Drop environmental documents<br>or click to browse files</span>
                    </div>
                </label>
                <input type="file" name="EnvironmentalFiles" id="environmental-files" class="file-input" multiple />
            </div>

            <div class="esg-card">
                <svg class="card-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" color="#3498db"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"></path></svg>
                <h3>Social</h3>
                <p>Employee welfare, diversity, community engagement</p>
                <label for="social-files" class="drop-zone" id="social-drop-zone">
                    <div class="drop-zone-prompt">
                        <svg class="drop-zone-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"></path></svg>
                        <span class="drop-zone-text">Drop social documents<br>or click to browse files</span>
                    </div>
                </label>
                <input type="file" name="SocialFiles" id="social-files" class="file-input" multiple />
            </div>

            <div class="esg-card">
                <svg class="card-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" color="#9b59b6"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"></path></svg>
                <h3>Governance</h3>
                <p>Board structure, compliance, risk management</p>
                <label for="governance-files" class="drop-zone" id="governance-drop-zone">
                    <div class="drop-zone-prompt">
                        <svg class="drop-zone-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"></path></svg>
                        <span class="drop-zone-text">Drop governance documents<br>or click to browse files</span>
                    </div>
                </label>
                <input type="file" name="GovernanceFiles" id="governance-files" class="file-input" multiple />
            </div>
        </div>

        <div class="button-container">
            <button type="button" class="btn btn-clear" id="clear-all-btn">Clear All Files</button>
            <button type="submit" class="btn btn-generate">⚡️ Generate AI Analysis</button>
        </div>
        <p class="upload-prompt mt-2">Upload documents to begin AI analysis</p>
    </form>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            console.log("DOM loaded. Initializing file input script.");

            const form = document.getElementById('esg-form');
            const clearButton = document.getElementById('clear-all-btn');
            const originalPrompts = new Map();

            // This function is correct and does not need to be changed.
            const updateDropZoneDisplay = (dropZone, fileInput) => {
                if (fileInput.files && fileInput.files.length > 0) {
                    dropZone.innerHTML = '';
                    const fileList = document.createElement('div');
                    fileList.className = 'file-list';
                    const fileCount = fileInput.files.length;
                    const fileText = `<strong>${fileCount} file${fileCount > 1 ? 's' : ''} selected:</strong>`;
                    const fileNames = Array.from(fileInput.files).map(f => f.name).join('<br>');
                    fileList.innerHTML = `${fileText}<br><small style="word-break: break-all;">${fileNames}</small>`;
                    dropZone.appendChild(fileList);
                } else {
                    if (originalPrompts.has(dropZone.id)) {
                        dropZone.innerHTML = originalPrompts.get(dropZone.id);
                    }
                }
            };

            // 💡 We will now loop through the INPUTS directly.
            document.querySelectorAll('.file-input').forEach(fileInput => {
                console.log("Attaching listeners to:", fileInput.id);

                // Find the associated LABEL (the drop zone) using its 'for' attribute.
                const dropZone = document.querySelector(`label[for="${fileInput.id}"]`);
                if (!dropZone) return;

                // Store the original state of the drop zone.
                originalPrompts.set(dropZone.id, dropZone.innerHTML);

                // ✅ Attach the listener DIRECTLY to the file input.
                // This is the most reliable way to catch the change.
                fileInput.addEventListener('change', function() {
                    console.log("File Input changed");
                    updateDropZoneDisplay(dropZone, fileInput);
                });

                // Drag-and-drop listeners are attached to the drop zone.
                dropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropZone.classList.add('dragover');
                });

                dropZone.addEventListener('dragleave', () => {
                    dropZone.classList.remove('dragover');
                });

                dropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropZone.classList.remove('dragover');
                    if (e.dataTransfer.files.length) {
                        fileInput.files = e.dataTransfer.files;
                        // Manually dispatch the event to trigger the listener above.
                        fileInput.dispatchEvent(new Event('change', { 'bubbles': true }));
                    }
                });
            });

            // "Clear All Files" button functionality.
            clearButton.addEventListener('click', () => {
                form.reset();
                document.querySelectorAll('.file-input').forEach(fileInput => {
                    const dropZone = document.querySelector(`label[for="${fileInput.id}"]`);
                    if (dropZone) {
                        updateDropZoneDisplay(dropZone, fileInput);
                    }
                });
            });
        });
    </script>
}